<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>603課堂管理整合工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background: linear-gradient(to right, #ffecd2, #fcb69f);
        }
        h1 {
            margin: 0;
            padding: 20px 0;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
        }
        #header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
        }
        #calendar {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        #calendarHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
        }
        #calendarMonth {
            font-size: 2em;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            text-align: center;
            width: 100%;
        }
        #calendarDays {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            text-align: center;
            color: #333;
            max-width: 1200px;
            margin-top: 5px;
        }
        .calendarDay {
            width: 135px;
            height: 90px;
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            overflow: hidden;
        }
        .calendarHeaderDay {
            font-weight: bold;
            font-size: 1.25em;
            text-align: center;
        }
        .calendarDay:nth-child(8n+1), .calendarDay:nth-child(8n+7) {
            background-color: #FFFFE0;
        }
        .calendarDay:nth-child(8n+1).hasData, .calendarDay:nth-child(8n+7).hasData {
            background-color: #ADD8E6;
        }
        .calendarDay:nth-child(8n+8) {
            background-color: #FFE4B5;
        }
        .today {
            font-size: 24px;
            color: red;
            font-weight: bold;
        }
        .hasData {
            background-color: #add8e6;
        }
        #studentNamesInput {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 1000;
        }
        #studentNamesInput h3, #studentNamesInput textarea, #studentNamesInput button {
            margin-bottom: 10px;
        }
        #studentNamesInputOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        #groupCountOverlay, #groupStudentsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        #groupCount, #groupStudents {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            text-align: left;
            position: relative;
            overflow-y: auto;
            max-height: 90%;
        }
        #groupStudents {
            width: calc(800px + 200px); /* 增加寬度 */
        }
        #groupCount h3, #groupCount p, #groupStudents h3, #groupStudents p {
            margin-bottom: 10px;
        }
        #groupCount button, #groupStudents button {
            margin-bottom: 10px;
        }
        #groupCount input {
            margin-bottom: 10px;
        }
        #inputSection {
            display: none;
            width: 100%;
            text-align: center;
        }
        #checklistSection {
            display: none;
            width: 100%;
            text-align: center;
        }
        textarea {
            width: 80%;
            height: 150px;
            margin-bottom: 10px;
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            color: black;
            margin: 5px;
            transition: background-color 0.3s ease, transform 0.2s;
            background-color: #d8bfd8;
        }
        button:hover {
            transform: scale(1.05);
            background-color: #c8a2c8;
        }
        .resetButton {
            background-color: #f44336;
            color: white;
        }
        .resetButton:hover {
            background-color: #d32f2f;
        }
        .monthlySummaryButton {
            background-color: #4caf50;
            color: white;
        }
        .monthlySummaryButton:hover {
            background-color: #388e3c;
        }
        .scoreTable {
            margin-top: 20px;
            border-collapse: collapse;
            display: inline-block;
            vertical-align: top;
            margin-right: 20px;
            background-color: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .groupScoreTable {
            background-color: #d0f0c0;
        }
        .scoreTable, .scoreTable th, .scoreTable td, .groupScoreTable th, .groupScoreTable td {
            border: 2px solid #000;
        }
        .scoreTable th, .groupScoreTable th {
            background-color: #E6E6FA;
        }
        .scoreTable th, .scoreTable td, .groupScoreTable th, .groupScoreTable td {
            padding: 8px;
            text-align: center;
        }
        .highlight {
            font-weight: bold;
            color: red;
        }
        #chart {
            margin-top: 20px;
            width: 500px;
        }
        #controlSection {
            margin-top: 20px;
            text-align: center;
        }
        #footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        #footer a {
            color: #fff;
            text-decoration: none;
        }
        #footer a:hover {
            text-decoration: underline;
        }
        .batchControl {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        .batchControl input {
            margin: 0 10px;
            padding: 5px;
            font-size: 16px;
            width: 60px;
            text-align: center;
        }
        #selectedDate {
            margin-top: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        .weekSummaryButton {
            font-size: 16px;
            color: black;
            background-color: #add8e6;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .weekSummaryButton:hover {
            background-color: #87ceeb;
        }
        #weeklySummaryOverlay, #monthlySummaryOverlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 60%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transform: translate(-50%, -50%);
        }
        #weeklySummaryContent, #monthlySummaryContent {
            background: white;
            width: 75%;
            height: 100%;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
    /* 隱藏座位表圖層中的特定元素 */
    #inputButton2, #saveButton2, #loadButton2, #resetButton2 {
        display: none;
    }
		
		
        .summary-text-overlay {
            position: absolute;
            top: 10px;
            left: 20px;
            width: 100px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            padding: 10px;
            text-align: left;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }
        .control-buttons button {
            flex: 1;
        }
        .control-buttons button:first-child {
            margin-right: auto;
            background-color: #4caf50;
            color: white;
        }
        .control-buttons button:nth-child(2) {
            background-color: #2196f3;
            color: white;
        }
        .control-buttons button:last-child {
            margin-left: auto;
            background-color: #ff9800;
            color: white;
        }
        .bottom-buttons {
            display: flex;
            gap: 10px;
        }
        .additionalText {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            background-color: transparent;
            font-size: 25px;
            color: red;
        }
        .additionalText button {
            cursor: pointer;
            padding: 5px;
            margin: 2px;
            border: none;
            background-color: #d8f3dc;
            font-size: 15px;
            color: red;
            font-weight: bold;
            border-radius: 50%;
            width: 30px;
            height: 30px;
        }
        .additionalText button:hover {
            background-color: #c2e7c7;
        }
        .additionalText .homeworkButton {
            background-color: blue;
            color: white;
            font-size: 15px;
            font-weight: bold;
        }
        .additionalText .hide {
            display: none;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .overlayContent {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            box-shadow: 0px 0px 10px black;
            font-weight: bold;
            color: black;
            max-height: 90%;
            overflow-y: auto;
        }
        .overlayContent h3 {
            margin: 0 0 10px;
            font-size: 20px;
            color: blue;
            text-shadow: 1px 1px 2px black;
        }
        .overlayContent .homeworkContent {
            font-size: 100px;
            text-align: left;
            color: blue;
            list-style-type: none;
            padding: 0;
            text-shadow: 2px 2px 5px black;
            white-space: nowrap;
        }
        .overlayContent button {
            padding: 10px 20px;
        }
        .hidden {
            display: none;
        }
        .assignmentList {
            text-align: left;
            font-size: 100px;
            color: blue;
            list-style-type: none;
            padding: 0;
        }
        .status-table {
            width: 48%;
            margin: 1%;
            border-collapse: collapse;
            box-shadow: none;
            border-radius: 0;
        }
        .status-table th, .status-table td {
            border: 2px solid #000;
            padding: 10px;
            text-align: center;
            color: #333;
            font-weight: bold;
        }
        .status-table th {
            font-size: 18px;
            color: blue;
        }
        .status-table th:nth-child(2), .status-table td:nth-child(2) {
            width: 33.33%;
        }
        .status-table th:nth-child(3), .status-table td:nth-child(3) {
            width: 33.33%;
        }
        .status-table th:nth-child(4), .status-table td:nth-child(4) {
            width: 33.33%;
        }
        .status-table td {
            color: initial;
        }
        @media print {
            @page {
                size: landscape;
            }
            body {
                -webkit-print-color-adjust: exact;
            }
        }
        #tables-container table, #tables-container th, #tables-container td {
            width: 90px;
            height: 15px;
            border: 2px solid #000;
            background-color: #dcdcdc;
        }
        #tables-container th, #tables-container td {
            padding: 0;
            text-align: center;
            text-shadow: 2px 2px 4px #aaa;
            background-color: #f0e68c;
        }
        #tables-container th {
            font-weight: bold;
            border: 2px solid #000;
        }
        .status-button {
            width: 100%;
            height: 100%;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #aaa;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: initial;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 2px solid #000;
            background-color: #dcdcdc;
            margin-left: 0px;
        }
        .status-button:hover {
            opacity: 0.8;
        }
        .status-toggle-button {
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #9370DB;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-shadow: 2px 2px 4px #aaa;
            display: block;
        }
        .status-toggle-button:hover {
            background-color: #7B68EE;
        }
        .export-button {
            background-color: #008CBA;
            color: white;
            font-size: 16px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .export-button:hover {
            background-color: #005f73;
        }
        .highlight {
            background-color: #ADD8E6;
        }
        .tables-container-wrapper {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .import-button, .export-button-main {
            background-color: #d8bfd8;
            color: black;
            font-size: 12px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .import-button:hover, .export-button-main:hover {
            background-color: #c8a2c8;
        }
        .themeButton {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            transition: transform 0.3s ease;
        }
        .themeButton:hover {
            transform: scale(1.1);
        }
        .theme1 {
            background: linear-gradient(to right, #ffecd2, #fcb69f);
        }
        .theme2 {
            background: linear-gradient(to right, #3a1c71, #d76d77, #ffaf7b);
        }
        .theme3 {
            background: linear-gradient(to right, #43cea2, #185a9d);
        }
        .theme4 {
            background: linear-gradient(to right, #4568dc, #b06ab3);
        }
        .themeButtonText {
            font-size: 18px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .buttonContainer {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .status-table-bg-1 {
            background-color: #ffe4e1;
        }
        .status-table-bg-2 {
            background-color: #e6e6fa;
        }
        .status-table-bg-3 {
            background-color: #f0fff0;
        }
        .status-table-bg-4 {
            background-color: #fff5ee;
        }
        .status-table-bg-5 {
            background-color: #f5f5dc;
        }
        .student-name {
            background-color: #f0e68c;
            border: 2px solid #000;
        }
        .summarySection {
            width: 100%;
            height: 100%;
            display: flex;
            transition: transform 0.5s ease;
        }
        .summarySection > div {
            width: 100%;
            flex-shrink: 0;
        }
        .rightArrow, .leftArrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            z-index: 10;
        }
        .rightArrow {
            right: 10px;
        }
        .leftArrow {
            left: 10px;
        }
        .groupContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
        }
        .group {
            background-color: #f0e68c;
            padding: 10px;
            border-radius: 4px;
            width: 22%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .group h4 {
            margin: 0 0 10px;
            font-size: 16px;
            text-align: center;
        }
        .group ul {
            list-style-type: none;
            padding: 0;
        }
        .group ul li {
            padding: 5px;
            margin: 5px 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: grab;
        }

        /* 教室座位表生成器 CSS (加上2以避免衝突) */
        body2 {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5e6f8; /* 淡紫色背景 */
        }
        header2 {
            background-color: #d7aefb; /* 淡紫色 */
            color: white;
            padding: 10px 0;
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        main2 {
            width: 90%;
            max-width: 1200px; /* 增加寬度 */
            margin: 20px 0;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        section2 {
            margin-bottom: 20px;
        }
        h22 {
            color: #5e35b1; /* 淡紫色 */
        }
        button2 {
            background-color: #d7aefb; /* 淡紫色 */
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        button2:hover {
            background-color: #ba68c8; /* 深淡紫色 */
        }
        #inputSection2 {
            display: inline-block;
            vertical-align: top;
        }
        #selectSection2, #settingsSection2, #groupSettingsSection2 {
            display: inline-block;
            vertical-align: top;
            margin-left: 20px;
        }
        #settingsSection2, #groupSettingsSection2 {
            display: none;
        }
        #seatingChart2 {
            display: grid;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .seat2, .student-seat2 {
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            min-height: 40px;
        }
        .blackboard2 {
            grid-column: span 5;
            text-align: center;
            background-color: #5e35b1; /* 深淡紫色 */
            color: white;
            padding: 10px;
            border-radius: 4px;
        }
        .group2 {
            border: 2px solid #d7aefb; /* 淡紫色 */
            border-radius: 4px;
            padding: 10px;
            margin: 10px;
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(3, 1fr);
            min-height: 150px;
        }
        .footer2 {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #5e35b1; /* 深淡紫色 */
        }
        .footer2 a {
            color: #5e35b1; /* 深淡紫色 */
            text-decoration: none;
        }
        .footer2 a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="header">
        <button class="resetButton" onclick="confirmReset()">重置</button>
        <h1>603課堂管理整合工具</h1>
        <div>
            <button onclick="showStudentNamesInput()">輸入學生姓名</button>
            <button id="groupButton" onclick="handleGroupButtonClick()">學生分組</button>
            <button onclick="showSeatingChart()">座位表</button>
        </div>
    </div>

    <div id="calendar">
        <div id="calendarHeader">
            <button onclick="changeMonth(-1)">上一個月</button>
            <h2 id="calendarMonth"></h2>
            <button class="monthlySummaryButton" onclick="showMonthlySummary()">每月統計</button>
            <button onclick="changeMonth(1)">下一個月</button>
        </div>
        <div id="calendarDays">
            <div class="calendarHeaderDay">日</div>
            <div class="calendarHeaderDay">一</div>
            <div class="calendarHeaderDay">二</div>
            <div class="calendarHeaderDay">三</div>
            <div class="calendarHeaderDay">四</div>
            <div class="calendarHeaderDay">五</div>
            <div class="calendarHeaderDay">六</div>
            <div class="calendarHeaderDay">統計</div>
        </div>
    </div>
    
    <div id="studentNamesInputOverlay" onclick="hideStudentNamesInput()"></div>
    <div id="studentNamesInput">
        <h3>輸入學生姓名，每一行一個名字</h3>
        <textarea id="studentNames" placeholder="每行輸入一個學生姓名"></textarea><br>
        <button onclick="submitNames()">送出</button>
    </div>

    <div id="groupCountOverlay" onclick="hideGroupCount()">
        <div id="groupCount" onclick="event.stopPropagation()">
            <h3>設定分組數量</h3>
            <p>設定分幾組：</p>
            <input type="number" id="groupCountInput" value="2" min="1">
            <button onclick="submitGroupCount()">送出</button>
            <button id="adjustGroupsButton" style="display: none;" onclick="showGroupStudents()">調整分組</button>
        </div>
    </div>
    
    <div id="groupStudentsOverlay" onclick="hideGroupStudents()">
        <div id="groupStudents" onclick="event.stopPropagation()">
            <h3>設定分組</h3>
            <div id="groupContainer" class="groupContainer"></div>
            <button onclick="submitGroups()">送出</button>
            <button id="adjustGroupsButton" style="display: none;" onclick="adjustGroups()">調整分組</button>
        </div>
    </div>

    <div id="inputSection">
        <div id="controlSection" class="control-buttons">
            <button onclick="goBack()">回上一頁</button>
            <button onclick="showScoreSection()">加扣分</button>
            <button onclick="showChartSection()">呈現直條圖</button>
        </div>
        <div id="selectedDate"></div>
        <div id="scoreSection" class="centered-section">
            <div id="studentScoreTable"></div>
            <div id="groupScoreTable"></div>
        </div>
        <div id="chartSection">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <div id="checklistSection">
        <div class="control-buttons">
            <button onclick="saveAndBack()">回上一頁</button>
            <button class="status-toggle-button" onclick="toggleStatusTables()">作業狀態</button>
            <button class="export-button" onclick="exportImage()">匯出圖片</button>
        </div>
        <h3 id="checklistDate"></h3>
        <div id="statusContainer" style="display: none; flex-wrap: wrap; justify-content: space-between; background-color: white;"></div>
        <div class="tables-container-wrapper">
            <div id="tablesContainer" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        </div>
    </div>

    <div id="weeklySummaryOverlay" class="overlay" onclick="hideWeeklySummary()">
        <div id="weeklySummaryContent" class="overlayContent" onclick="event.stopPropagation()">
            <div class="summary-text-overlay" id="weeklySummaryText">每週統計</div>
            <div class="summarySection">
                <div id="weeklyScoreSection"></div>
                <canvas id="weeklyChart" style="width: 50%; height: 175px;"></canvas>
            </div>
            <div class="rightArrow" onclick="slideRight('weeklySummaryContent')">&#9654;</div>
            <div class="leftArrow" onclick="slideLeft('weeklySummaryContent')" style="display: none;">&#9664;</div>
        </div>
    </div>

    <div id="monthlySummaryOverlay" class="overlay" onclick="hideWeeklySummary()">
        <div id="monthlySummaryContent" class="overlayContent" onclick="event.stopPropagation()">
            <div class="summary-text-overlay" id="monthlySummaryText">每月統計</div>
            <div class="summarySection">
                <div id="monthlyScoreSection"></div>
                <canvas id="monthlyChart" style="width: 50%; height: 175px;"></canvas>
            </div>
            <div class="rightArrow" onclick="slideRight('monthlySummaryContent')">&#9654;</div>
            <div class="leftArrow" onclick="slideLeft('monthlySummaryContent')" style="display: none;">&#9664;</div>
        </div>
    </div>

    <div id="footer">
        Designed by <a href="https://kentxchang.blogspot.tw" target="_blank">阿剛老師</a>
    </div>

    <div id="homeworkOverlay" class="overlay" onclick="hideOverlay(event, 'homeworkOverlay')">
        <div class="overlayContent" onclick="event.stopPropagation()">
            <h3 id="homeworkDate"></h3>
            <textarea id="homeworkText" placeholder="每行輸入一項作業"></textarea><br>
            <button onclick="submitHomework()">送出</button>
        </div>
    </div>

    <div id="viewHomeworkOverlay" class="overlay" onclick="hideOverlay(event, 'viewHomeworkOverlay')">
        <div class="overlayContent" onclick="event.stopPropagation()">
            <ul id="assignmentList" class="homeworkContent"></ul>
            <h3 id="viewHomeworkDate"></h3>
        </div>
    </div>

    <div style="position: fixed; bottom: 10px; left: 10px;" id="importExportButtons">
        <button class="export-button-main" onclick="exportData()">匯出</button>
        <input type="file" id="importFile" style="display: none;" onchange="importData(event)">
        <button class="import-button" onclick="document.getElementById('importFile').click()">匯入</button>
    </div>

    <div class="buttonContainer" id="themeButtonsContainer">
        <button class="themeButton theme1" onclick="changeTheme('theme1')">暖陽之晨</button>
        <button class="themeButton theme2" onclick="changeTheme('theme2')">繽紛繽紛</button>
        <button class="themeButton theme3" onclick="changeTheme('theme3')">清新一夏</button>
        <button class="themeButton theme4" onclick="changeTheme('theme4')">紫霞仙子</button>
    </div>

    <!-- 教室座位表生成器 -->
    <div id="seatingChartOverlay" class="overlay" onclick="hideSeatingChart()">
        <div id="seatingChartContent" class="overlayContent" onclick="event.stopPropagation()">
            <header2>
                <h1>教室座位表生成器</h1>
            </header2>
            <main2>
                <div id="inputSection2">
                    <section2>
                        <h22></h22>
                        <button2 id="inputButton2">輸入學生</button2>
                    </section2>
                </div>
                <div id="selectSection2">
                    <section2>
                        <h22>選擇分組方式</h22>
                        <label>分組方式：
                            <select id="groupingMethod2">
                                <option value="">請選擇</option>
                                <option value="byColumn">按列分組</option>
                                <option value="byGroup">按組分組</option>
                            </select>
                        </label>
                    </section2>
                </div>
                <div id="settingsSection2">
                    <section2>
                        <h22>座位表設置</h22>
                        <label>列數：<input type="number" id="columns2" min="1" value="5"></label>
                        <button2 id="generateButton2">生成座位表</button2>
                    </section2>
                </div>
                <div id="groupSettingsSection2">
                    <section2>
                        <h22>分組設置</h22>
                        <label>組數：<input type="number" id="groups2" min="1" max="9" value="9"></label>
                        <button2 id="groupButton2">按組排列座位</button2>
                    </section2>
                </div>
                <section2>
                    <h22>座位表</h22>
                    <div id="seatingChart2">
                        <!-- 座位表將顯示在此處 -->
                    </div>
                </section2>
                <section2>
                    <h22>選項</h22>
                    <button2 id="saveButton2">保存座位表</button2>
                    <button2 id="loadButton2">加載座位表</button2>
                    <button2 id="previewButton2">預覽座位表</button2>
                    <button2 id="resetButton2">重置</button2>
                </section2>
            </main2>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
    <script>
        const backgroundColors = ['#FFFACD', '#FFDAB9', '#E6E6FA', '#E0FFFF', '#F0E68C'];
        document.body.style.backgroundColor = backgroundColors[Math.floor(Math.random() * backgroundColors.length)];

        // 取得當前HTML檔案的名稱作為前綴
        const fileName = window.location.pathname.split("/").pop().split(".")[0];
        const localStoragePrefix = `${fileName}_`;

        let students = JSON.parse(localStorage.getItem(localStoragePrefix + 'students')) || [];
        let scores = JSON.parse(localStorage.getItem(localStoragePrefix + 'scores')) || {};
        let homeworks = JSON.parse(localStorage.getItem(localStoragePrefix + 'homeworks')) || {};
        let groups = JSON.parse(localStorage.getItem(localStoragePrefix + 'groups')) || {};
        let chart;
        let weeklyChart;
        let monthlyChart;
        let currentMonth = new Date();
        let currentDay = null;
        let scoresChanged = false;

        document.getElementById('calendar').style.display = 'block';
        document.getElementById('header').style.display = 'flex';
        document.getElementById('importExportButtons').style.display = 'block';
        renderCalendar();

        function showStudentNamesInput() {
            document.getElementById('studentNamesInput').style.display = 'block';
            document.getElementById('studentNamesInputOverlay').style.display = 'block';
        }

        function hideStudentNamesInput() {
            document.getElementById('studentNamesInput').style.display = 'none';
            document.getElementById('studentNamesInputOverlay').style.display = 'none';
        }

        function handleGroupButtonClick() {
            if (Object.keys(scores).length > 0) {
                alert("分組已有加扣分資料，不可調整分組。");
            } else {
                showGroupCount();
            }
        }

        function showGroupCount() {
            document.getElementById('groupCountOverlay').style.display = 'flex';
            if (Object.keys(groups).length > 0) {
                document.getElementById('adjustGroupsButton').style.display = 'block';
            } else {
                document.getElementById('adjustGroupsButton').style.display = 'none';
            }
        }

        function hideGroupCount() {
            document.getElementById('groupCountOverlay').style.display = 'none';
        }

        function showGroupStudents() {
            document.getElementById('groupStudentsOverlay').style.display = 'flex';
            renderGroups();
        }

        function hideGroupStudents() {
            document.getElementById('groupStudentsOverlay').style.display = 'none';
        }

        function submitNames() {
            const names = document.getElementById('studentNames').value.trim().split('\n').map(name => name.trim());
            const newStudents = names.filter(name => !students.includes(name) && name !== '');
            newStudents.forEach(name => {
                if (!students.includes(name) && name !== '') {
                    students.push(name);
                }
            });
            autoAssignNewStudents(newStudents);
            localStorage.setItem(localStoragePrefix + 'students', JSON.stringify(students));
            hideStudentNamesInput();
            renderCalendar();
        }

        function autoAssignNewStudents(newStudents) {
            newStudents.forEach(student => {
                let minGroupIndex = 0;
                let minGroupSize = Infinity;
                Object.keys(groups).forEach(groupIndex => {
                    if (groups[groupIndex].length < minGroupSize) {
                        minGroupSize = groups[groupIndex].length;
                        minGroupIndex = groupIndex;
                    }
                });
                groups[minGroupIndex].push(student);
            });
            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
        }

        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = `
                <div class="calendarHeaderDay">日</div>
                <div class="calendarHeaderDay">一</div>
                <div class="calendarHeaderDay">二</div>
                <div class="calendarHeaderDay">三</div>
                <div class="calendarHeaderDay">四</div>
                <div class="calendarHeaderDay">五</div>
                <div class="calendarHeaderDay">六</div>
                <div class="calendarHeaderDay">統計</div>
            `;
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const firstDayIndex = firstDayOfMonth.getDay();
            const lastDayIndex = lastDayOfMonth.getDay();
            const prevLastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 0).getDate();
            const lastDay = lastDayOfMonth.getDate();
            const today = new Date();
            let weekDayCount = 0;

            document.getElementById('calendarMonth').textContent = currentMonth.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });

            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                day.classList.add('prevMonthDay');
                day.textContent = prevLastDay - i + 1;
                calendarDays.appendChild(day);
                weekDayCount++;
            }

            for (let i = 1; i <= lastDay; i++) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                day.innerHTML = `<div onclick="showDailyScoreSection(${i})">${i}</div>
                                <div class="additionalText">
                                    <button class="homeworkButton" onclick="showHomeworkOverlay(event, '${dateKey}')">作</button>
                                    <button class="hide" onclick="showViewHomeworkOverlay(event, '${dateKey}')">聯</button>
                                    <button class="hide" onclick="showChecklistSection('${dateKey}')">檢</button>
                                </div>`;
                if (today.getFullYear() === currentMonth.getFullYear() && 
                    today.getMonth() === currentMonth.getMonth() && 
                    today.getDate() === i) {
                    day.classList.add('today');
                }
                if (homeworks[dateKey]) {
                    day.querySelector(".homeworkButton").nextElementSibling.classList.remove('hide');
                    day.querySelector(".homeworkButton").nextElementSibling.nextElementSibling.classList.remove('hide');
                }
                if (scores[dateKey]) {
                    day.classList.add('hasData');
                    if (day.classList.contains('calendarDay:nth-child(8n+1)') || day.classList.contains('calendarDay:nth-child(8n+7)')) {
                        day.style.backgroundColor = '#ADD8E6';
                    }
                }
                calendarDays.appendChild(day);
                weekDayCount++;
                if (weekDayCount === 7) {
                    const weekSummary = document.createElement('div');
                    weekSummary.classList.add('calendarDay');
                    weekSummary.innerHTML = `<button class="weekSummaryButton" onclick="showWeeklySummary(${i - 6}, ${i})">每週\n統計</button>`;
                    calendarDays.appendChild(weekSummary);
                    weekDayCount = 0;
                }
            }

            for (let i = 1; i < 7 - lastDayIndex; i++) {
                const day = document.createElement('div');
                day.classList.add('calendarDay');
                day.classList.add('nextMonthDay');
                day.textContent = i;
                calendarDays.appendChild(day);
                weekDayCount++;
                if (weekDayCount === 7) {
                    const weekSummary = document.createElement('div');
                    weekSummary.classList.add('calendarDay');
                    weekSummary.innerHTML = `<button class="weekSummaryButton" onclick="showWeeklySummary(${lastDay + i - 6}, ${lastDay + i})">每週\n統計</button>`;
                    calendarDays.appendChild(weekSummary);
                    weekDayCount = 0;
                }
            }

            if (Object.keys(scores).length > 0) {
                document.getElementById('groupButton').textContent = '已分組';
            }
        }

        function changeMonth(months) {
            currentMonth.setMonth(currentMonth.getMonth() + months);
            renderCalendar();
        }

        function showDailyScoreSection(day) {
            currentDay = day;
            scoresChanged = false;
            document.getElementById('selectedDate').textContent = `日期: ${currentMonth.getFullYear()}${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}${day.toString().padStart(2, '0')}`;
            document.getElementById('calendar').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            document.getElementById('importExportButtons').style.display = 'none';
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('controlSection').style.display = 'flex';
            document.getElementById('themeButtonsContainer').style.display = 'none';
            updateScoreTables();
            showScoreSection();
        }

        function showScoreSection() {
            document.getElementById('scoreSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'none';
        }

        function showChartSection() {
            document.getElementById('scoreSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'block';
            renderChart();
        }

        function goBack() {
            if (scoresChanged) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
                const dayElement = [...document.getElementsByClassName('calendarDay')].find(day => day.innerHTML.includes(`showDailyScoreSection(${currentDay})`));
                if (dayElement) {
                    dayElement.classList.add('hasData');
                    if (dayElement.classList.contains('calendarDay:nth-child(8n+1)') || dayElement.classList.contains('calendarDay:nth-child(8n+7)')) {
                        dayElement.style.backgroundColor = '#ADD8E6';
                    }
                }
            }
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('checklistSection').style.display = 'none';
            document.getElementById('calendar').style.display = 'block';
            document.getElementById('header').style.display = 'flex';
            document.getElementById('importExportButtons').style.display = 'block';
            document.getElementById('themeButtonsContainer').style.display = 'flex';
            location.reload();  // 新增這一行代碼來重整頁面
        }

        function updateScoreTables() {
            const studentScoreTable = document.getElementById('studentScoreTable');
            const groupScoreTable = document.getElementById('groupScoreTable');
            studentScoreTable.innerHTML = '';
            groupScoreTable.innerHTML = '';
            let currentStudentTable = createScoreTable();
            let currentGroupTable = createGroupScoreTable();
            studentScoreTable.appendChild(currentStudentTable);
            groupScoreTable.appendChild(currentGroupTable);
            students.forEach((name, index) => {
                if (index % 10 === 0 && index !== 0) {
                    currentStudentTable = createScoreTable();
                    studentScoreTable.appendChild(currentStudentTable);
                }
                addRowToTable(currentStudentTable, name, index);
            });
            Object.keys(groups).forEach((groupIndex, index) => {
                if (index % 5 === 0 && index !== 0) {
                    currentGroupTable = createGroupScoreTable();
                    groupScoreTable.appendChild(currentGroupTable);
                }
                addGroupRowToTable(currentGroupTable, groupIndex, index);
            });
            highlightTopScore();
        }

        function createScoreTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thAdd = document.createElement('th');
            const thScore = document.createElement('th');
            const thSubtract = document.createElement('th');
            thName.textContent = '姓名';
            thAdd.textContent = '加分';
            thScore.textContent = '得分';
            thSubtract.textContent = '扣分';
            row.appendChild(thName);
            row.appendChild(thAdd);
            row.appendChild(thScore);
            row.appendChild(thSubtract);
            table.createTBody();
            return table;
        }

        function createGroupScoreTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable groupScoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thAdd = document.createElement('th');
            const thScore = document.createElement('th');
            const thSubtract = document.createElement('th');
            const thMembers = document.createElement('th');
            thName.textContent = '組別';
            thAdd.textContent = '加分';
            thScore.textContent = '得分';
            thSubtract.textContent = '扣分';
            thMembers.textContent = '組員';
            row.appendChild(thName);
            row.appendChild(thAdd);
            row.appendChild(thScore);
            row.appendChild(thSubtract);
            row.appendChild(thMembers);
            table.createTBody();
            return table;
        }

        function addRowToTable(table, name, index) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellAdd = row.insertCell(1);
            const cellScore = row.insertCell(2);
            const cellSubtract = row.insertCell(3);

            cellName.textContent = name;
            cellAdd.innerHTML = `<button onclick="changeScore('${name}-${index}', 1)">+</button>`;
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            cellScore.textContent = scores[dateKey][`${name}-${index}`] || 0;
            cellSubtract.innerHTML = `<button onclick="changeScore('${name}-${index}', -1)">-</button>`;
        }

        function addGroupRowToTable(table, groupIndex, index) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellAdd = row.insertCell(1);
            const cellScore = row.insertCell(2);
            const cellSubtract = row.insertCell(3);
            const cellMembers = row.insertCell(4);

            cellName.textContent = `第${parseInt(groupIndex) + 1}組`;
            cellAdd.innerHTML = `<button onclick="changeGroupScore('${groupIndex}', 1, this)">+</button>`;
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            cellScore.textContent = scores[dateKey][`group-${groupIndex}`] || 0;
            cellSubtract.innerHTML = `<button onclick="changeGroupScore('${groupIndex}', -1, this)">-</button>`;
            cellMembers.textContent = groups[groupIndex].join(', ');
        }

        function changeScore(key, delta) {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            scores[dateKey][key] = (scores[dateKey][key] || 0) + delta;
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            updateScoreTables();
            scoresChanged = true;
        }

        function changeGroupScore(groupIndex, delta, button) {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) {
                scores[dateKey] = {};
            }
            groups[groupIndex].forEach(student => {
                const key = `${student}-${students.indexOf(student)}`;
                scores[dateKey][key] = (scores[dateKey][key] || 0) + delta;
            });
            scores[dateKey][`group-${groupIndex}`] = (scores[dateKey][`group-${groupIndex}`] || 0) + delta;
            const groupScoreCell = button.parentElement.nextElementSibling;
            groupScoreCell.textContent = scores[dateKey][`group-${groupIndex}`];
            localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
            updateScoreTables();
            scoresChanged = true;
        }

        function highlightTopScore() {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            if (!scores[dateKey]) return;
            const maxScore = Math.max(...Object.values(scores[dateKey]));
            const cells = document.querySelectorAll('.scoreTable td:nth-child(3)');
            cells.forEach(cell => {
                cell.classList.remove('highlight');
                if (parseInt(cell.textContent) === maxScore) {
                    cell.classList.add('highlight');
                }
            });
        }

        function renderChart() {
            const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${currentDay}`;
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: students,
                    datasets: [{
                        label: '得分',
                        data: students.map((name, index) => scores[dateKey] ? (scores[dateKey][`${name}-${index}`] || 0) : 0),
                        backgroundColor: students.map((name, index) => scores[dateKey] && (scores[dateKey][`${name}-${index}`] === Math.max(...Object.values(scores[dateKey])) ? 'darkblue' : 'rgba(54, 162, 235, 0.7)')),
                        borderColor: students.map((name, index) => scores[dateKey] && (scores[dateKey][`${name}-${index}`] === Math.max(...Object.values(scores[dateKey])) ? 'darkblue' : 'rgba(54, 162, 235, 1)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: students.length <= 6 ? 0 : 90,
                                minRotation: 0,
                                font: function(context) {
                                    const width = context.chart.width;
                                    const size = students.length <= 6 ? 14 : Math.round(width / students.length / 1.5);
                                    return {
                                        size: size > 8 ? size : 8,
                                    };
                                }
                            }
                        }
                    }
                }
            });
        }

        function confirmReset() {
            if (confirm("確定要重置所有資料嗎？")) {
                localStorage.removeItem(localStoragePrefix + 'students');
                localStorage.removeItem(localStoragePrefix + 'scores');
                localStorage.removeItem(localStoragePrefix + 'homeworks');
                localStorage.removeItem(localStoragePrefix + 'groups');
                students = [];
                scores = {};
                homeworks = {};
                groups = {};
                document.getElementById('calendar').style.display = 'block';
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('checklistSection').style.display = 'none';
                document.getElementById('studentNamesInput').style.display = 'none';
                document.getElementById('header').style.display = 'flex';
                document.getElementById('importExportButtons').style.display = 'block';
                renderCalendar();
				location.reload(); // 新增這行代碼來刷新畫面
            }
        }

        function showWeeklySummary(startDay, endDay) {
            const summaryData = {};
            for (let i = startDay; i <= endDay; i++) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                if (scores[dateKey]) {
                    Object.keys(scores[dateKey]).forEach(key => {
                        summaryData[key] = (summaryData[key] || 0) + scores[dateKey][key];
                    });
                }
            }

            document.getElementById('weeklySummaryOverlay').style.display = 'flex';
            document.getElementById('weeklySummaryText').textContent = '每週統計';

            const weeklyScoreSection = document.getElementById('weeklyScoreSection');
            weeklyScoreSection.innerHTML = '';
            let currentTable = createWeeklySummaryTable();
            weeklyScoreSection.appendChild(currentTable);
            const sortedScores = Object.entries(summaryData).sort(([,a],[,b]) => b-a);
            const topScores = sortedScores.slice(0, 3);
            students.forEach((name, index) => {
                if (index % 7 === 0 && index !== 0) {
                    currentTable = createWeeklySummaryTable();
                    weeklyScoreSection.appendChild(currentTable);
                }
                addSummaryRowToTable(currentTable, name, index, summaryData, topScores);
            });
            renderSummaryChart(summaryData, 'weeklyChart');
        }

        function showMonthlySummary() {
            const summaryData = {};
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
            for (let i = 1; i <= lastDay; i++) {
                const dateKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth() + 1}-${i}`;
                if (scores[dateKey]) {
                    Object.keys(scores[dateKey]).forEach(key => {
                        summaryData[key] = (summaryData[key] || 0) + scores[dateKey][key];
                    });
                }
            }

            document.getElementById('monthlySummaryOverlay').style.display = 'flex';
            document.getElementById('monthlySummaryText').textContent = '每月統計';

            const monthlyScoreSection = document.getElementById('monthlyScoreSection');
            monthlyScoreSection.innerHTML = '';
            let currentTable = createWeeklySummaryTable();
            monthlyScoreSection.appendChild(currentTable);
            const sortedScores = Object.entries(summaryData).sort(([,a],[,b]) => b-a);
            const topScores = sortedScores.slice(0, 3);
            students.forEach((name, index) => {
                if (index % 7 === 0 && index !== 0) {
                    currentTable = createWeeklySummaryTable();
                    monthlyScoreSection.appendChild(currentTable);
                }
                addSummaryRowToTable(currentTable, name, index, summaryData, topScores);
            });
            renderSummaryChart(summaryData, 'monthlyChart');
        }

        function createWeeklySummaryTable() {
            const table = document.createElement('table');
            table.className = 'scoreTable';
            const thead = table.createTHead();
            const row = thead.insertRow();
            const thName = document.createElement('th');
            const thScore = document.createElement('th');
            thName.textContent = '姓名';
            thScore.textContent = '得分';
            row.appendChild(thName);
            row.appendChild(thScore);
            table.createTBody();
            return table;
        }

        function addSummaryRowToTable(table, name, index, summaryData, topScores) {
            const tbody = table.getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            const cellName = row.insertCell(0);
            const cellScore = row.insertCell(1);
            const score = summaryData[`${name}-${index}`] || 0;

            const topScoreIndex = topScores.findIndex(([key, value]) => key === `${name}-${index}`);
            if (topScoreIndex !== -1) {
                cellName.innerHTML = `<span style="font-weight: bold; color: red;">${name} (${topScoreIndex + 1})</span>`;
                cellScore.innerHTML = `<span style="font-weight: bold; color: red;">${score}</span>`;
            } else {
                cellName.textContent = name;
                cellScore.textContent = score;
            }
        }

        function renderSummaryChart(summaryData, chartId) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (chartId === 'weeklyChart' && weeklyChart) {
                weeklyChart.destroy();
            } else if (chartId === 'monthlyChart' && monthlyChart) {
                monthlyChart.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: students,
                    datasets: [{
                        label: '得分',
                        data: students.map((name, index) => summaryData[`${name}-${index}`] || 0),
                        backgroundColor: students.map((name, index) => summaryData[`${name}-${index}`] === Math.max(...Object.values(summaryData)) ? 'darkblue' : 'rgba(54, 162, 235, 0.2)'),
                        borderColor: students.map((name, index) => summaryData[`${name}-${index}`] === Math.max(...Object.values(summaryData)) ? 'darkblue' : 'rgba(54, 162, 235, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: students.length <= 6 ? 0 : 90,
                                minRotation: 0,
                                font: function(context) {
                                    const width = context.chart.width;
                                    const size = students.length <= 6 ? 14 : Math.round(width / students.length / 1.5);
                                    return {
                                        size: size > 8 ? size : 8,
                                    };
                                }
                            }
                        }
                    }
                }
            });

            if (chartId === 'weeklyChart') {
                weeklyChart = newChart;
            } else if (chartId === 'monthlyChart') {
                monthlyChart = newChart;
            }
        }

        function hideWeeklySummary() {
            document.getElementById('weeklySummaryOverlay').style.display = 'none';
            document.getElementById('monthlySummaryOverlay').style.display = 'none';
        }

        function showHomeworkOverlay(event, dateKey) {
            event.stopPropagation();
            document.getElementById('homeworkOverlay').style.display = 'flex';
            document.getElementById('homeworkDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('homeworkDate').dataset.dateKey = dateKey;
            document.getElementById('homeworkText').value = homeworks[dateKey] ? homeworks[dateKey].join('\n') : '';
        }

        function hideOverlay(event, overlayId) {
            event.stopPropagation();
            document.getElementById(overlayId).style.display = 'none';
        }

        function submitHomework() {
            const dateKey = document.getElementById('homeworkDate').dataset.dateKey;
            const homeworkText = document.getElementById('homeworkText').value.trim();
            if (homeworkText) {
                homeworks[dateKey] = homeworkText.split('\n').map(item => item.trim()).filter(item => item);
                localStorage.setItem(localStoragePrefix + 'homeworks', JSON.stringify(homeworks));
                const dayElement = document.querySelector(`.calendarDay button[onclick*="showHomeworkOverlay(event, '${dateKey}')"]`).parentNode;
                dayElement.querySelector('.hide').classList.remove('hide');
                dayElement.querySelectorAll('button')[2].classList.remove('hide');
            }
            hideOverlay(event, 'homeworkOverlay');
        }

        function showViewHomeworkOverlay(event, dateKey) {
            event.stopPropagation();
            document.getElementById('viewHomeworkOverlay').style.display = 'flex';
            document.getElementById('viewHomeworkDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            const assignmentList = document.getElementById('assignmentList');
            assignmentList.innerHTML = '';
            if (homeworks[dateKey]) {
                homeworks[dateKey].forEach((item, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. ${item}`;
                    assignmentList.appendChild(li);
                });
            }
        }

        function showChecklistSection(dateKey) {
            const storedData = JSON.parse(localStorage.getItem(`checklist_${dateKey}`)) || {};
            const homeworkList = homeworks[dateKey] || [];
            document.getElementById('checklistDate').textContent = new Date(dateKey).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('checklistDate').dataset.dateKey = dateKey;
            document.getElementById('statusContainer').innerHTML = generateStatusTables(homeworkList);
            document.getElementById('tablesContainer').innerHTML = generateChecklistTables(homeworkList, storedData);
            document.getElementById('calendar').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            document.getElementById('checklistSection').style.display = 'block';
            document.getElementById('importExportButtons').style.display = 'none';
            document.getElementById('themeButtonsContainer').style.display = 'none';
            updateStatusLists();
        }

        function generateStatusTables(cols) {
            const colors = ['#ffe4e1', '#e6e6fa', '#f0fff0', '#fff5ee', '#f5f5dc'];
            return cols.map((col, index) => `
                <table class="status-table" style="background-color: white;">
                    <thead>
                        <tr>
                            <th colspan="3" style="border: 2px solid #000; background-color: ${colors[index % colors.length]}; font-size: 21px; color: blue;">${col}</th>
                        </tr>
                        <tr>
                            <th style="border: 2px solid #000; background-color: ${colors[index % colors.length]};">未繳交</th>
                            <th style="border: 2px solid #000; background-color: ${colors[index % colors.length]};">待訂正</th>
                            <th style="border: 2px solid #000; background-color: ${colors[index % colors.length]};">已訂正</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="not-submitted-${col}" style="border: 2px solid #000; background-color: #dcdcdc;"></td>
                            <td id="correction-${col}" style="border: 2px solid #000; background-color: #dcdcdc;"></td>
                            <td id="corrected-${col}" style="border: 2px solid #000; background-color: #dcdcdc;"></td>
                        </tr>
                    </tbody>
                </table>
            `).join('');
        }

        function generateChecklistTables(cols, storedData) {
            const colors = ['#ffe4e1', '#e6e6fa', '#f0fff0', '#fff5ee', '#f5f5dc'];
            let tables = '';
            const chunkSize = 10;
            for (let i = 0; i < students.length; i += chunkSize) {
                tables += `
                    <table style="table-layout: fixed; margin: 10px; border-collapse: collapse; background-color: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
                        <thead>
                            <tr>
                                <th class="student-name" style="width: 90px; height: 15px;" onclick="toggleStudentStatus('${students.slice(i, i + chunkSize).map(student => student)}')">學生姓名</th>
                                ${cols.map((col, index) => col.trim() !== '' ? `<th style="width: 90px; height: 15px; border: 2px solid #000; background-color: ${colors[index % colors.length]};" onclick="toggleAssignmentStatus('${col.trim()}')">${col}</th>` : '').join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${generateChecklistRows(cols, i, i + chunkSize, storedData)}
                        </tbody>
                    </table>
                `;
            }
            return tables;
        }

        function generateChecklistRows(cols, start, end, storedData) {
            let rows = '';
            const chunk = students.slice(start, end);
            chunk.forEach((student, index) => {
                let assignments = '';
                for (let i = 0; i < cols.length; i++) {
                    if (cols[i].trim() !== '') {
                        const assignment = cols[i].trim();
                        const status = storedData[assignment] && storedData[assignment][student] ? storedData[assignment][student] : 'red';
                        const text = status === 'red' ? '未繳交' : status === 'green' ? '已繳交' : status === 'orange' ? '待訂正' : '已訂正';
                        assignments += `
                            <td style="width: 90px; height: 15px; background-color: #dcdcdc; border: 2px solid #000;">
                                <button class="status-button" style="background-color: ${status}; color: white;" onclick="toggleButtonStatus(this, '${student}', '${assignment}')">${text}</button>
                            </td>
                        `;
                    }
                }
                rows += `
                    <tr>
                        <td class="student-name" style="width: 90px; height: 15px; background-color: #f0e68c; font-weight: bold; border: 2px solid #000;" onclick="toggleStudentStatus('${student}')">${student}</td>
                        ${assignments}
                    </tr>
                `;
            });
            return rows;
        }

        function toggleButtonStatus(button, student, assignment) {
            if (button.style.backgroundColor === 'red') {
                button.style.backgroundColor = 'green';
                button.textContent = '已繳交';
            } else if (button.style.backgroundColor === 'green') {
                button.style.backgroundColor = 'orange';
                button.textContent = '待訂正';
            } else if (button.style.backgroundColor === 'orange') {
                button.style.backgroundColor = 'blue';
                button.textContent = '已訂正';
            } else {
                button.style.backgroundColor = 'red';
                button.textContent = '未繳交';
            }
            updateStatusLists();
        }

        function toggleAssignmentStatus(assignment) {
            const buttons = document.querySelectorAll(`button[onclick*="${assignment}"]`);
            buttons.forEach(button => {
                toggleButtonStatus(button, button.closest('tr').querySelector('.student-name').textContent, assignment);
            });
        }

        function toggleStudentStatus(student) {
            const buttons = document.querySelectorAll(`button[onclick*="${student}"]`);
            buttons.forEach(button => {
                const assignment = button.closest('table').querySelector('thead th:nth-child(' + (Array.from(button.closest('tr').children).indexOf(button.closest('td')) + 1) + ')').textContent.trim();
                toggleButtonStatus(button, student, assignment);
            });
        }

        function updateStatusLists() {
            const notSubmittedLists = {};
            const correctionLists = {};
            const correctedLists = {};

            document.querySelectorAll('.status-table th').forEach(th => {
                const col = th.textContent.trim();
                notSubmittedLists[col] = document.getElementById(`not-submitted-${col}`);
                correctionLists[col] = document.getElementById(`correction-${col}`);
                correctedLists[col] = document.getElementById(`corrected-${col}`);
                if (notSubmittedLists[col]) notSubmittedLists[col].innerHTML = '';
                if (correctionLists[col]) correctionLists[col].innerHTML = '';
                if (correctedLists[col]) correctedLists[col].innerHTML = '';
            });

            const buttons = document.querySelectorAll('.status-button');
            buttons.forEach(button => {
                const student = button.closest('tr').querySelector('.student-name').textContent;
                const assignment = button.closest('table').querySelector('thead th:nth-child(' + (Array.from(button.closest('tr').children).indexOf(button.closest('td')) + 1) + ')').textContent;

                if (button.style.backgroundColor === 'red' && notSubmittedLists[assignment]) {
                    notSubmittedLists[assignment].innerHTML += `${notSubmittedLists[assignment].innerHTML ? ', ' : ''}${student}`;
                } else if (button.style.backgroundColor === 'orange' && correctionLists[assignment]) {
                    correctionLists[assignment].innerHTML += `${correctionLists[assignment].innerHTML ? ', ' : ''}${student}`;
                } else if (button.style.backgroundColor === 'blue' && correctedLists[assignment]) {
                    correctedLists[assignment].innerHTML += `${correctedLists[assignment].innerHTML ? ', ' : ''}${student}`;
                }
            });
        }

        function saveAndBack() {
            const dateKey = document.getElementById('checklistDate').dataset.dateKey;
            const statusData = {};
            const buttons = document.querySelectorAll('.status-button');
            buttons.forEach(button => {
                const student = button.closest('tr').querySelector('.student-name').textContent;
                const assignment = button.closest('table').querySelector('thead th:nth-child(' + (Array.from(button.closest('tr').children).indexOf(button.closest('td')) + 1) + ')').textContent.trim();
                if (!statusData[assignment]) statusData[assignment] = {};
                statusData[assignment][student] = button.style.backgroundColor;
            });
            localStorage.setItem(`checklist_${dateKey}`, JSON.stringify(statusData));
            goBack();
        }

        function exportData() {
            const data = {
                students,
                scores,
                homeworks,
                groups
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            
            // 取得當前日期並格式化
            const currentDate = new Date();
            const formattedDate = currentDate.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '-'); // 將日期格式化為 YYYY-MM-DD
            
            // 設定新的檔名
            const fileName = `603教師課堂管理整合工具資料備份_${formattedDate}.json`;
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName); // 使用新的檔名
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            document.body.removeChild(downloadAnchorNode);
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const importedData = JSON.parse(event.target.result);
                students = importedData.students;
                scores = importedData.scores;
                homeworks = importedData.homeworks;
                groups = importedData.groups;
                localStorage.setItem(localStoragePrefix + 'students', JSON.stringify(students));
                localStorage.setItem(localStoragePrefix + 'scores', JSON.stringify(scores));
                localStorage.setItem(localStoragePrefix + 'homeworks', JSON.stringify(homeworks));
                localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
                renderCalendar();
                alert('資料已成功匯入');
            };
            reader.readAsText(file);
        }

        function exportImage() {
            const element = document.querySelector('#checklistSection');
            html2canvas(element).then(canvas => {
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `checklist-${document.getElementById('checklistDate').dataset.dateKey}.png`;
                link.click();
            });
        }

        function changeTheme(theme) {
            const themes = {
                'theme1': 'linear-gradient(to right, #ffecd2, #fcb69f)',
                'theme2': 'linear-gradient(to right, #3a1c71, #d76d77, #ffaf7b)',
                'theme3': 'linear-gradient(to right, #43cea2, #185a9d)',
                'theme4': 'linear-gradient(to right, #4568dc, #b06ab3)'
            };
            document.body.style.background = themes[theme];
        }

        function toggleStatusTables() {
            const statusContainer = document.getElementById('statusContainer');
            if (statusContainer.style.display === 'none') {
                statusContainer.style.display = 'flex';
            } else {
                statusContainer.style.display = 'none';
            }
        }

        function slideRight(contentId) {
            const content = document.getElementById(contentId);
            const summarySection = content.querySelector('.summarySection');
            const leftArrow = content.querySelector('.leftArrow');
            const rightArrow = content.querySelector('.rightArrow');
            summarySection.style.transform = 'translateX(-100%)';
            leftArrow.style.display = 'block';
            rightArrow.style.display = 'none';
        }

        function slideLeft(contentId) {
            const content = document.getElementById(contentId);
            const summarySection = content.querySelector('.summarySection');
            const leftArrow = content.querySelector('.leftArrow');
            const rightArrow = content.querySelector('.rightArrow');
            summarySection.style.transform = 'translateX(0)';
            leftArrow.style.display = 'none';
            rightArrow.style.display = 'block';
        }

        function submitGroupCount() {
            const groupCount = document.getElementById('groupCountInput').value;
            groups = {};
            for (let i = 0; i < groupCount; i++) {
                groups[i] = [];
            }

            students.forEach((student, index) => {
                groups[index % groupCount].push(student);
            });

            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
            hideGroupCount();
            showGroupStudents();
        }

        function renderGroups() {
            const groupContainer = document.getElementById('groupContainer');
            groupContainer.innerHTML = '';
            Object.keys(groups).forEach(groupIndex => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';
                groupDiv.innerHTML = `<h4>第 ${parseInt(groupIndex) + 1} 組</h4><ul id="group-${groupIndex}">${groups[groupIndex].map(student => `<li draggable="true" ondragstart="drag(event)" id="${student}">${student}</li>`).join('')}</ul>`;
                groupContainer.appendChild(groupDiv);
            });

            const uls = document.querySelectorAll('.group ul');
            uls.forEach(ul => {
                ul.ondragover = function (event) {
                    event.preventDefault();
                };
                ul.ondrop = function (event) {
                    event.preventDefault();
                    const studentId = event.dataTransfer.getData("text");
                    const studentElement = document.getElementById(studentId);
                    if (studentElement) {
                        const oldGroup = studentElement.parentElement;
                        ul.appendChild(studentElement);
                        updateGroups();
                    }
                };
            });
        }

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }

        function updateGroups() {
            const groupCount = document.getElementById('groupCountInput').value;
            groups = {};
            for (let i = 0; i < groupCount; i++) {
                groups[i] = [];
            }

            Object.keys(groups).forEach(groupIndex => {
                const ul = document.getElementById(`group-${groupIndex}`);
                ul.querySelectorAll('li').forEach(studentElement => {
                    groups[groupIndex].push(studentElement.id);
                });
            });

            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
        }

        function submitGroups() {
            localStorage.setItem(localStoragePrefix + 'groups', JSON.stringify(groups));
            hideGroupStudents();
        }

        function adjustGroups() {
            renderGroups();
        }

        // 教室座位表生成器相關函數
        let studentList2 = [];
        let seatingChartData2 = [];
        let draggedElement2 = null;

        document.getElementById('inputButton2').addEventListener('click', inputStudentList2);
        document.getElementById('generateButton2').addEventListener('click', generateSeatingChart2);
        document.getElementById('groupButton2').addEventListener('click', generateGroupedSeatingChart2);
        document.getElementById('saveButton2').addEventListener('click', saveSeatingChart2);
        document.getElementById('loadButton2').addEventListener('click', loadSeatingChart2);
        document.getElementById('previewButton2').addEventListener('click', previewSeatingChart2);
        document.getElementById('resetButton2').addEventListener('click', resetSeatingChart2);
        document.getElementById('groupingMethod2').addEventListener('change', toggleSettings2);

        function showSeatingChart() {
            document.getElementById('seatingChartOverlay').style.display = 'flex';
            studentList2 = students.map(name => ({ name }));
            renderSeatingChart2();
        }

        function hideSeatingChart() {
            document.getElementById('seatingChartOverlay').style.display = 'none';
        }

        function inputStudentList2() {
            const input = prompt('輸入學生姓名，每行一個:');
            if (input) {
                studentList2 = input.split('\n').map(name => ({ name: name.trim() })).filter(student => student.name);
                const method = document.getElementById('groupingMethod2').value;
                if (method === 'byColumn') {
                    generateSeatingChart2();
                } else {
                    generateGroupedSeatingChart2();
                }
            }
        }

        function toggleSettings2() {
            const method = document.getElementById('groupingMethod2').value;
            if (method === 'byColumn') {
                document.getElementById('settingsSection2').style.display = 'inline-block';
                document.getElementById('groupSettingsSection2').style.display = 'none';
            } else if (method === 'byGroup') {
                document.getElementById('settingsSection2').style.display = 'none';
                document.getElementById('groupSettingsSection2').style.display = 'inline-block';
            } else {
                document.getElementById('settingsSection2').style.display = 'none';
                document.getElementById('groupSettingsSection2').style.display = 'none';
            }
        }

        function generateSeatingChart2() {
            const columns = parseInt(document.getElementById('columns2').value);
            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';

            const blackboard2 = document.createElement('div');
            blackboard2.className = 'blackboard2';
            blackboard2.textContent = '黑板';
            blackboard2.style.gridColumn = `span ${columns}`;
            seatingChart2.appendChild(blackboard2);

            seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            seatingChartData2 = [];
            shuffleArray(studentList2);

            const totalSeats = Math.ceil(studentList2.length / columns) * columns;
            for (let i = 0; i < totalSeats; i++) {
                const seat2 = document.createElement('div');
                seat2.className = 'seat2';
                if (i < studentList2.length) {
                    seat2.textContent = studentList2[i].name;
                }
                seat2.draggable = true;
                seat2.addEventListener('dragstart', handleDragStart2);
                seat2.addEventListener('dragover', handleDragOver2);
                seat2.addEventListener('drop', handleDrop2);
                seat2.addEventListener('dragend', handleDragEnd2);
                seatingChart2.appendChild(seat2);
                seatingChartData2.push({ index: i + 1, name: i < studentList2.length ? studentList2[i].name : '' });
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateGroupedSeatingChart2() {
            const groups = parseInt(document.getElementById('groups2').value);
            const totalGroups = 9; // 固定9個組
            const columns = 3; // 固定3列來生成9個組的空格

            const groupSizes = calculateGroupSizes2(studentList2.length, groups);
            const groupedStudents = assignStudentsToGroups2(studentList2, groupSizes);

            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';
            seatingChart2.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            const blackboard2 = document.createElement('div');
            blackboard2.className = 'blackboard2';
            blackboard2.textContent = '黑板';
            blackboard2.style.gridColumn = `span ${columns}`;
            seatingChart2.appendChild(blackboard2);

            for (let i = 0; i < totalGroups; i++) {
                const groupContainer2 = document.createElement('div');
                groupContainer2.className = `group2 group-${i}`;
                groupContainer2.style.gridColumn = `span 1`;
                groupContainer2.draggable = true;
                groupContainer2.addEventListener('dragstart', handleDragStart2);
                groupContainer2.addEventListener('dragover', handleDragOver2);
                groupContainer2.addEventListener('drop', handleDropGroup2);
                groupContainer2.addEventListener('dragend', handleDragEnd2);
                seatingChart2.appendChild(groupContainer2);

                if (i < groupedStudents.length) {
                    groupedStudents[i].forEach(student => {
                        const seat2 = document.createElement('div');
                        seat2.className = 'student-seat2';
                        seat2.textContent = student.name;
                        seat2.draggable = true;
                        seat2.addEventListener('dragstart', handleDragStart2);
                        seat2.addEventListener('dragover', handleDragOver2);
                        seat2.addEventListener('drop', handleDrop2);
                        seat2.addEventListener('dragend', handleDragEnd2);
                        groupContainer2.appendChild(seat2);
                    });
                }

                const totalSpaces = 9; // 3x3 格子
                while (groupContainer2.children.length < totalSpaces) {
                    const emptySeat2 = document.createElement('div');
                    emptySeat2.className = 'student-seat2';
                    emptySeat2.draggable = true;
                    emptySeat2.addEventListener('dragstart', handleDragStart2);
                    emptySeat2.addEventListener('dragover', handleDragOver2);
                    emptySeat2.addEventListener('drop', handleDrop2);
                    emptySeat2.addEventListener('dragend', handleDragEnd2);
                    groupContainer2.appendChild(emptySeat2);
                }
            }
            updateSeatingChartData2();
        }

        function calculateGroupSizes2(totalStudents, numberOfGroups) {
            const groupSizes = new Array(numberOfGroups).fill(Math.floor(totalStudents / numberOfGroups));
            for (let i = 0; i < totalStudents % numberOfGroups; i++) {
                groupSizes[i]++;
            }
            return groupSizes;
        }

        function assignStudentsToGroups2(studentList, groupSizes) {
            const shuffledStudents = [...studentList];
            shuffleArray(shuffledStudents);
            const groups = [];
            let studentIndex = 0;
            for (let size of groupSizes) {
                const group = shuffledStudents.slice(studentIndex, studentIndex + size);
                groups.push(group);
                studentIndex += size;
            }
            return groups;
        }

        function handleDragStart2(event) {
            draggedElement2 = event.target;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', event.target.textContent);
        }

        function handleDragOver2(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handleDrop2(event) {
            event.preventDefault();
            if (event.target.classList.contains('seat2') || event.target.classList.contains('student-seat2')) {
                const draggedText2 = draggedElement2.textContent;
                const targetText2 = event.target.textContent;

                draggedElement2.textContent = targetText2;
                event.target.textContent = draggedText2;

                updateSeatingChartData2();
            }
        }

        function handleDropGroup2(event) {
            event.preventDefault();
            if (event.target.classList.contains('group2')) {
                const draggedHTML2 = draggedElement2.innerHTML;
                const targetHTML2 = event.target.innerHTML;

                draggedElement2.innerHTML = targetHTML2;
                event.target.innerHTML = draggedHTML2;

                reattachEventListeners2(draggedElement2);
                reattachEventListeners2(event.target);

                updateSeatingChartData2();
            }
        }

        function handleDragEnd2() {
            draggedElement2 = null;
        }

        function reattachEventListeners2(groupContainer) {
            Array.from(groupContainer.children).forEach(seat => {
                seat.draggable = true;
                seat.addEventListener('dragstart', handleDragStart2);
                seat.addEventListener('dragover', handleDragOver2);
                seat.addEventListener('drop', handleDrop2);
                seat.addEventListener('dragend', handleDragEnd2);
            });
            groupContainer.draggable = true;
            groupContainer.addEventListener('dragstart', handleDragStart2);
            groupContainer.addEventListener('dragover', handleDragOver2);
            groupContainer.addEventListener('drop', handleDropGroup2);
            groupContainer.addEventListener('dragend', handleDragEnd2);
        }

        function updateSeatingChartData2() {
            const seats2 = document.querySelectorAll('.seat2, .student-seat2');
            seatingChartData2 = Array.from(seats2).map((seat2, index) => ({
                index: index + 1,
                name: seat2.textContent.trim() || ''
            }));
        }

        function saveSeatingChart2() {
            const data = {
                seatingChartData2: seatingChartData2,
                groupingMethod2: document.getElementById('groupingMethod2').value
            };
            const dataStr2 = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode2 = document.createElement('a');
            downloadAnchorNode2.setAttribute("href", dataStr2);
            downloadAnchorNode2.setAttribute("download", "seating_chart.json");
            document.body.appendChild(downloadAnchorNode2);
            downloadAnchorNode2.click();
            downloadAnchorNode2.remove();
        }

        function loadSeatingChart2() {
            const input2 = document.createElement('input');
            input2.type = 'file';
            input2.accept = '.json';
            input2.addEventListener('change', event => {
                const file2 = event.target.files[0];
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    const data2 = JSON.parse(e.target.result);
                    seatingChartData2 = data2.seatingChartData;
                    document.getElementById('groupingMethod2').value = data2.groupingMethod;
                    toggleSettings2();
                    renderSeatingChart2();
                };
                reader2.readAsText(file2);
            });
            input2.click();
        }

        function previewSeatingChart2() {
            const className2 = prompt('請輸入班級名稱:');
            if (className2) {
                const previewWindow2 = window.open('', '_blank');
                previewWindow2.document.write(`
                    <html>
                    <head>
                        <title>${className2} 座位表</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                background-color: #f4f4f9;
                                margin: 0;
                                padding: 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            }
                            h1 {
                                color: #333;
                            }
                            .seatingChart {
                                display: grid;
                                gap: 10px;
                                justify-content: center;
                                margin-top: 20px;
                                width: 1200px;
                            }
                            .student-seat2, .seat2 {
                                background-color: #f1f1f1;
                                border: 1px solid #ddd;
                                padding: 10px;
                                border-radius: 4px;
                                text-align: center;
                                min-height: 30px;
                            }
                            .blackboard2 {
                                text-align: center;
                                background-color: #333;
                                color: white;
                                padding: 10px;
                                border-radius: 4px;
                            }
                            .group2 {
                                border: 2px solid #4CAF50;
                                border-radius: 4px;
                                padding: 10px;
                                margin: 10px;
                                display: grid;
                                gap: 10px;
                                grid-template-columns: repeat(3, 1fr);
                                min-height: 150px;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${className2} 座位表</h1>
                        <div class="seatingChart">${document.getElementById('seatingChart2').innerHTML}</div>
                    </body>
                    </html>
                `);
                previewWindow2.document.close();
            }
        }

        function resetSeatingChart2() {
            seatingChartData2 = [];
            studentList2 = [];
            document.getElementById('groupingMethod2').value = '';
            document.getElementById('columns2').value = 5;
            document.getElementById('groups2').value = 9;
            toggleSettings2();
            document.getElementById('seatingChart2').innerHTML = '';
        }

        function saveSeatingChart2() {
            const data2 = {
                seatingChartData: seatingChartData2,
                groupingMethod: document.getElementById('groupingMethod2').value
            };
            const dataStr2 = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data2));
            const downloadAnchorNode2 = document.createElement('a');
            downloadAnchorNode2.setAttribute("href", dataStr2);
            downloadAnchorNode2.setAttribute("download", "seating_chart.json");
            document.body.appendChild(downloadAnchorNode2);
            downloadAnchorNode2.click();
            downloadAnchorNode2.remove();
        }

        function saveSeatingChartToLocalStorage2() {
            const data2 = {
                seatingChartData: seatingChartData2,
                groupingMethod: document.getElementById('groupingMethod2').value
            };
            localStorage.setItem('seatingChartData2', JSON.stringify(data2));
        }

        function loadSeatingChartFromLocalStorage2() {
            const savedData2 = localStorage.getItem('seatingChartData2');
            if (savedData2) {
                const data2 = JSON.parse(savedData2);
                seatingChartData2 = data2.seatingChartData;
                document.getElementById('groupingMethod2').value = data2.groupingMethod;
                toggleSettings2();
                renderSeatingChart2();
            }
        }

        function renderSeatingChart2() {
            const seatingChart2 = document.getElementById('seatingChart2');
            seatingChart2.innerHTML = '';
            const method2 = document.getElementById('groupingMethod2').value;

            if (method2 === 'byColumn') {
                const columns2 = parseInt(document.getElementById('columns2').value);
                seatingChart2.style.gridTemplateColumns = `repeat(${columns2}, 1fr)`;

                const blackboard2 = document.createElement('div');
                blackboard2.className = 'blackboard2';
                blackboard2.textContent = '黑板';
                blackboard2.style.gridColumn = `span ${columns2}`;
                seatingChart2.appendChild(blackboard2);

                seatingChartData2.forEach(data2 => {
                    const seat2 = document.createElement('div');
                    seat2.className = 'seat2';
                    seat2.textContent = data2.name;
                    seat2.draggable = true;
                    seat2.addEventListener('dragstart', handleDragStart2);
                    seat2.addEventListener('dragover', handleDragOver2);
                    seat2.addEventListener('drop', handleDrop2);
                    seat2.addEventListener('dragend', handleDragEnd2);
                    seatingChart2.appendChild(seat2);
                });
            } else if (method2 === 'byGroup') {
                const totalGroups2 = 9; // 固定9個組
                const columns2 = 3; // 固定3列來生成9個組的空格
                seatingChart2.style.gridTemplateColumns = `repeat(${columns2}, 1fr)`;

                const blackboard2 = document.createElement('div');
                blackboard2.className = 'blackboard2';
                blackboard2.textContent = '黑板';
                blackboard2.style.gridColumn = `span ${columns2}`;
                seatingChart2.appendChild(blackboard2);

                for (let i = 0; i < totalGroups2; i++) {
                    const groupContainer2 = document.createElement('div');
                    groupContainer2.className = `group2 group-${i}`;
                    groupContainer2.style.gridColumn = `span 1`;
                    groupContainer2.draggable = true;
                    groupContainer2.addEventListener('dragstart', handleDragStart2);
                    groupContainer2.addEventListener('dragover', handleDragOver2);
                    groupContainer2.addEventListener('drop', handleDropGroup2);
                    groupContainer2.addEventListener('dragend', handleDragEnd2);
                    seatingChart2.appendChild(groupContainer2);

                    const groupData2 = seatingChartData2.filter((data2, index2) => Math.floor(index2 / 9) === i);
                    groupData2.forEach(data2 => {
                        const seat2 = document.createElement('div');
                        seat2.className = 'student-seat2';
                        seat2.textContent = data2.name;
                        seat2.draggable = true;
                        seat2.addEventListener('dragstart', handleDragStart2);
                        seat2.addEventListener('dragover', handleDragOver2);
                        seat2.addEventListener('drop', handleDrop2);
                        seat2.addEventListener('dragend', handleDragEnd2);
                        groupContainer2.appendChild(seat2);
                    });

                    const totalSpaces2 = 9; // 3x3 格子
                    while (groupContainer2.children.length < totalSpaces2) {
                        const emptySeat2 = document.createElement('div');
                        emptySeat2.className = 'student-seat2';
                        emptySeat2.draggable = true;
                        emptySeat2.addEventListener('dragstart', handleDragStart2);
                        emptySeat2.addEventListener('dragover', handleDragOver2);
                        emptySeat2.addEventListener('drop', handleDrop2);
                        emptySeat2.addEventListener('dragend', handleDragEnd2);
                        groupContainer2.appendChild(emptySeat2);
                    }
                }
            }
        }

        window.addEventListener('load', loadSeatingChartFromLocalStorage2);
        window.addEventListener('beforeunload', saveSeatingChartToLocalStorage2);
    </script>
</body>
</html>
